<?php
header("Cache-Control: no-cache");
?>

<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>IoT Weather Station</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-KK94CHFLLe+nY2dmCWGMq91rCGa5gtU4mk92HdvYe+M/SXH301p5ILy+dN9+nJOZ" crossorigin="anonymous">
</head>

<body>
    <div class="container my-4">
        <h1>IoT Weather Station</h1>

        <div class="my-5">
            <canvas id="myChart" class="w-100"></canvas>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/chart.umd.min.js"></script>
    <script>
        function updateChart(raw) {

            const readings = raw.split("\n").map(x => x.split(",")).filter(x => x.length == 4);
            const dates = readings.map(x => new Date(parseInt(x[0]) * 1000));
            const readingNumbers = Array.from({ length: readings.length }, (x, i) => i / 60);
            const sensorIDs = readings.map(x => x[1]);
            const temperatures = readings.map(x => x[2]);
            const pressures = readings.map(x => x[3]);

            const data = {
                labels: dates,
                datasets: [
                    {
                        label: 'Indoor',
                        data: temperatures,
                        fill: false,
                        tension: 0.1,
                    }
                ]
            };

            const config = {
                type: 'line',
                data: data,
                options: {
                    responsive: false,
                    elements: {
                        point: {
                            radius: 0
                        }
                    },
                    plugins: {
                        legend: {
                            display: false,
                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                callback: function (val, index) {
                                    const hour = String(dates[index].getHours());
                                    const minute = String(dates[index].getMinutes()).padStart(2, '0');
                                    return hour + ":" + minute;
                                },
                                color: 'red',
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: "Temperature (F)"
                            }
                        }
                    },
                }
            };

            new Chart(document.getElementById('myChart'), config);
        }

        fetch("https://swharden.com/weather/v1/read/", { cache: "no-store" })
            .then(response => response.text())
            .then(data => updateChart(data));
    </script>
</body>

</html>